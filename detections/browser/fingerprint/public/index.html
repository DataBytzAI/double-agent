<html lang="en">
  <head>
    <script src="fingerprint2.js" type="text/javascript"></script>
    <title>Browser Fingerprinting</title>
  </head>
  <body>
    <h3>Fingerprint</h3>
    <p id="fingerprint">generating...</p>
    <pre id="details"></pre>
    <script type="text/javascript">
      const useragentAttributes = ['userAgent', 'platform'];
      // unstable across requests, per https://github.com/Valve/fingerprintjs2/wiki/Stable-components
      const unstableAttributes = ['canvas', 'webgl', 'enumerateDevices'];

      const checkedOtherPlaces = [
        'webdriver',
        'hasLiedLanguages',
        'hasLiedResolution',
        'hasLiedOs',
        'hasLiedBrowser',
      ];

      function fingerprint() {
        Fingerprint2.get(
          {
            // exclude all the "Detections" of false behavior - we cover these in other places
            excludes: {
              enumerateDevices: false,
              pixelRatio: false,
              doNotTrack: false,
            },
          },
          components => {
            const allValues = components
              .filter(x => x.key !== 'enumerateDevices')
              .map(x => x.value);

            const browserValues = components
              .filter(
                x => !useragentAttributes.includes(x.key) && !checkedOtherPlaces.includes(x.key),
              )
              .map(x => x.value);
            const stableValues = components
              .filter(
                x => !unstableAttributes.includes(x.key) && !checkedOtherPlaces.includes(x.key),
              )
              .map(x => x.value);

            const fullHash = Fingerprint2.x64hash128(allValues.join(''), 31);
            const browserHash = Fingerprint2.x64hash128(browserValues.join(''), 31);
            const stableHash = Fingerprint2.x64hash128(stableValues.join(''), 31);

            document.getElementById('details').innerText = JSON.stringify(components, null, 2);
            document.getElementById('fingerprint').innerText =
              'Stable: ' + stableHash + ', Full: ' + fullHash + ', CrossBrowser: ' + browserHash;
            fetch('/results', {
              method: 'POST',
              body: JSON.stringify({
                components,
                fullHash,
                browserHash,
                stableHash,
              }),
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(() => {
              document.body.classList.add('done');
            });
          },
        );
      }

      window.requestIdleCallback ? requestIdleCallback(fingerprint) : setTimeout(fingerprint, 500);
    </script>
  </body>
</html>
